# v0.3.0 Graph-Based Architecture Implementation

**Date**: 2024-12-16
**Status**: Complete

## Summary

Implemented graph-based architecture for PAOLA, replacing the session-based approach (v0.2.0) with a more flexible graph structure that explicitly captures optimization strategy relationships.

## Key Concepts

- **Graph** = Complete optimization task (may involve multiple nodes)
- **Node** = Single optimizer execution within a graph
- **Edge** = Relationship between nodes (warm_start, restart, refine, branch, explore)

**Design Principle**: "Graph externalizes state, agent makes decisions."
- The graph helps the agent track state (node IDs, not x0 values)
- The agent explicitly decides which node to continue from
- The system does NOT automatically select "best" - that's the agent's decision

## Implementation Phases

### Phase 1: Graph Schema (`paola/foundry/schema/graph.py`)
- `EdgeType`: Enum for edge types (warm_start, restart, refine, branch, explore)
- `OptimizationEdge`: Edge between nodes with type and metadata
- `OptimizationNode`: Single optimizer execution with progress data
- `GraphDecision`: Agent decision record
- `OptimizationGraph`: Complete graph with nodes, edges, and analysis methods

**Graph patterns detected**: single, multistart, chain, tree, dag

### Phase 2: ActiveGraph (`paola/foundry/active_graph.py`)
- `ActiveNode`: In-progress node tracking with iteration recording
- `ActiveGraph`: Manages active optimization graph
  - Node lifecycle (start_node, complete_node)
  - Edge creation with parent node specification
  - Decision recording
  - State queries for agent decision-making

### Phase 3: Foundry API (`paola/foundry/foundry.py`)
- `create_graph()`: Create new optimization graph
- `get_graph()`: Get active graph by ID
- `finalize_graph()`: Finalize and persist graph
- `load_graph()`: Load completed graph from storage
- `query_graphs()`: Query graphs with filters

### Phase 4: Graph Tools (`paola/tools/`)

**7 tools total** (designed for minimal, robust LLM interaction):

Graph Lifecycle (3):
- `start_graph(problem_id, goal)` - Create new optimization graph
- `get_graph_state(graph_id)` - Get graph state for agent decision-making
- `finalize_graph(graph_id, success, notes)` - Complete and persist graph

Optimization Execution (1):
- `run_optimization(graph_id, optimizer, config, init_strategy, parent_node, edge_type)`

Information (3):
- `get_problem_info(problem_id)` - Get problem characteristics
- `list_optimizers()` - List available optimizer backends
- `get_optimizer_options(optimizer)` - Get optimizer configuration options

**Key design decisions**:
1. Explicit graph creation required (agent knows it's starting a graph)
2. LLM explicitly specifies `parent_node` and `edge_type`
3. `get_graph_state` kept separate from `run_optimization`
4. `get_optimizer_options` retained (may remove after experiments)

### Phase 5: CLI Updates (`paola/cli/`)

**New commands**:
- `/graphs` - List all optimization graphs
- `/graph show <id>` - Show detailed graph information with ASCII tree
- `/graph plot <id>` - Plot convergence history
- `/graph compare <id1> <id2>` - Compare graphs side-by-side
- `/graph best` - Show best solution across all graphs

**General commands** now prefer graphs over sessions:
- `/show`, `/plot`, `/compare`, `/best` check for graphs first

**Graph visualization**: ASCII tree format showing parent-child relationships
```
  (n1)
   └─(n2)
     ├─(n3)
     └─(n4)
```

## Files Changed

### New Files
- `paola/foundry/schema/graph.py` - Graph schema definitions
- `paola/foundry/active_graph.py` - Active graph management
- `paola/tools/graph_tools.py` - Graph lifecycle tools
- `tests/test_graph_schema.py` - Graph schema tests
- `tests/test_active_graph.py` - ActiveGraph and storage tests
- `docs/architecture/20251216_optimization_graph_design.md` - Design document

### Modified Files
- `paola/foundry/foundry.py` - Added graph API
- `paola/foundry/storage/file_storage.py` - Added graph storage
- `paola/foundry/schema/__init__.py` - Export graph types
- `paola/tools/optimization_tools.py` - Updated for graph-based execution
- `paola/cli/repl.py` - Added graph tools and commands
- `paola/cli/commands.py` - Added graph command handlers
- `CLAUDE.md` - Updated documentation for v0.3.0

## Test Coverage

- 81 tests passing
- Tests cover: EdgeType, OptimizationEdge, OptimizationNode, GraphDecision, OptimizationGraph
- Tests cover: ActiveNode, ActiveGraph, Foundry graph API, graph storage

## Commits

1. `56aa70f` - Add Optimization Graph architecture design for v0.3.0
2. `51e7251` - Implement graph schema for v0.3.0 (Phase 1)
3. `82500c6` - Implement ActiveGraph and storage for v0.3.0 (Phase 2)
4. `b52f1f9` - Update Foundry API for graph support (Phase 3)
5. `4c7ba8c` - Update architecture doc with final tool design (7 tools)
6. `6f1f2a6` - Implement graph tools for v0.3.0 (Phase 4)
7. `b85e225` - Update CLI for graph-based architecture (Phase 5)
8. `93338f4` - Update CLAUDE.md to reflect v0.3.0 graph-based architecture
9. `4c9f5d0` - Fix CLI graph commands attribute errors
10. `5120ee4` - Fix graph ASCII visualization with proper tree connections

## Next Steps

1. **Experiment with graph exposure**: Test whether exposing graph structure to LLM helps or confuses
2. **Evaluate tool usage**: Monitor which tools are actually used, remove unnecessary ones
3. **Knowledge base integration**: Connect graph patterns to knowledge retrieval
4. **Multi-graph analysis**: Compare strategies across multiple graphs
